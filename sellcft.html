<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CFT Token</title>
  <link rel="icon" href="https://raw.githubusercontent.com/ClaimTRX/Test/main/favicon-32x32.png" type="image/png">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
  <style>
    body {
      background-color: #1a1a2e;
      color: #fff;
      font-family: Arial, sans-serif;
    }

    .sidebar {
      height: 100vh;
      background-color: #162447;
      padding: 15px;
      position: fixed;
      width: 200px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .sidebar a {
      color: #fff;
      text-decoration: none;
      display: block;
      padding: 10px 0;
      width: 100%;
      text-align: center;
    }

    .sidebar a:hover {
      background-color: #1f4068;
    }

    .sidebar .social-links {
      display: flex;
      margin-top: 20px;
    }

    .sidebar .social-icon {
      color: white;
      font-size: 20px;
      margin-right: 10px;
      text-decoration: none;
    }

    .sidebar .social-icon:last-child {
      margin-right: 0;
    }

    .topbar {
      background-color: #162447;
      padding: 10px;
      text-align: right;
      margin-left: 200px;
      display: flex;
      align-items: center;
      justify-content: flex-end;
    }

    .topbar button {
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      padding: 8px 16px;
    }

    .main-content {
      margin-left: 220px;
      padding: 20px;
    }

    .main-content h1 {
      text-align: center;
      width: 100%;
      margin-left: auto;
      margin-right: auto;
    }

    /* Ensure card and content fit properly */
    .card {
        background-color: #2c3e50;
        color: white;
        border: none;
        border-radius: 10px;
        margin-bottom: 20px;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        max-width: 1200px;
        margin: 20px auto;
    }

    .card-body {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-gap: 20px;
      width: 100%;
    }

    .card-text-section p {
      font-size: 18px;
      line-height: 1.6;
      margin-bottom: 10px;
    }

    .card-explanation {
      margin-top: 10px;
      font-size: 0.875rem;
    }

    .form-control {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      border-radius: 5px;
      margin-bottom: 10px;
    }

    .btn {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      border-radius: 5px;
      margin-top: 10px;
    }

    .btn-success {
      background-color: #4CAF50;
    }

    .btn-danger {
      background-color: #ff4c4c;
    }

    /* Ensure long text breaks properly */
    .card p, .listing p {
      word-wrap: break-word;
      word-break: break-all; /* Force breaks for long strings */
      font-size: 14px; /* Adjust text size for better fit */
      line-height: 1.4; /* Adjust line height to give more space between lines */
    }

    /* Ensure button stays within the card */
    .card button, .listing button {
      width: 100%; /* Make the button take full width of the card on mobile */
      font-size: 14px; /* Adjust font size for the button */
    }

    /* Mobile responsiveness */
    @media (max-width: 767.98px) {
      .sidebar {
        height: auto;
        padding: 10px;
        width: 100%;
        position: relative;
        flex-direction: column;
        align-items: center;
      }

      .topbar {
        text-align: center;
        margin-left: 0;
        justify-content: center;
      }

      .main-content {
        margin-left: 0;
      }

      .card-body {
        grid-template-columns: 1fr;
        padding: 10px;
      }

      .card-text-section {
        width: 100%;
        padding: 0 10px;
        margin-bottom: 20px;
      }

      .card-explanation {
        margin-top: 20px;
      }

      .btn {
        width: 100%;
        padding: 12px;
        font-size: 14px;
      }

      .form-control {
        width: 100%;
        padding: 12px;
        font-size: 14px;
      }

      .sidebar .social-links {
        justify-content: center;
      }

      .sidebar .social-icon {
        margin-bottom: 10px;
      }

      .listing {
        display: flex;
        flex-direction: column;
        align-items: flex-start; /* Align items vertically */
        padding: 10px 0;
      }

      .listing p {
        margin-bottom: 5px; /* Ensure spacing between text */
        font-size: 14px; /* Small font for better fit */
      }

      .listing button {
        margin-bottom: 10px; /* Add space between buttons and content */
        width: 100%; /* Ensure buttons take full width */
      }
    }

    @media (min-width: 768px) {
      .card-body {
        grid-template-columns: 1fr 1fr;
        justify-content: space-between;
      }

      .form-control {
        font-size: 1rem;
      }

      .btn {
        font-size: 1rem;
      }

      .card-explanation {
        font-size: 1rem;
      }
    }

    

  </style>
</head>
<body>
  <div class="sidebar">
    <h2>CFT</h2>
     <a href="index.html">Welcome</a>
    <a href="buy.html">Buy CFT</a>
    <a href="staking.html">CFT Staking</a>
    <a href="Swap.html">Swap</a>
    <a href="meme.html">Meme Staking</a>
    <div class="social-links">
      <a href="https://x.com/cfttrc20?s=21" target="_blank" class="social-icon">
        <i class="fab fa-twitter"></i>
      </a>
      <a href="https://t.me/claimfreetrxnow" target="_blank" class="social-icon">
        <i class="fab fa-telegram-plane"></i>
      </a>
    </div>
  </div>
  <div class="topbar">
    <button id="connect-button">Connect Wallet</button>
  </div>
  <div class="main-content">
    <h1>List your CFT for sale</h1>
    
    <!-- Marketplace Box -->
    <div class="card mt-4">
      <div class="card-body">
        <div class="card-text-section">
          
          <p class="card-text">List your CFT Tokens</p>
          <input type="number" id="tokenAmount" class="form-control" placeholder="Amount of Tokens">
          <input type="number" id="pricePerTokenInTRX" class="form-control" placeholder="Total price in TRX">
          <button id="approveAndListButton" class="btn btn-success">Approve and List</button>
        </div>
        <div class="card-explanation">
          <p>To ensure users can trade their token, the ecosystem treasury will buy back any listed tokens that are not traded P2P within a reasonable timeframe.<br>
          This only happens if the tokens are listed at the same price the seller bought them at.</p>
          <p>Orders cannot be filled partially, so keep this in mind when listing your tokens.</p>
        </div>
      </div>
    </div>

    <!-- Listed for Sale Box -->
    <div class="card mt-4">
      <div class="card-body">
        <div class="card-text-section">
          <h5 class="card-title">Listed tokens</h5>
          <div id="listings" class="card-text">Loading...</div>
        </div>
        <div class="card-explanation">
          <p>Listed tokens will appear here. When there are tokens listed for sale at or below market price, we will close the buy option to ensure users who want to buy CFT<br>
          will buy them from the Marketplace.</p>
        </div>
      </div>
    </div>
  </div>
</body>
</html>




  </div>
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tronweb/dist/TronWeb.min.js"></script>
  <script>
    let tronWeb, userAddress,  tokenContract,  marketplaceContract;
    const tokenContractAddress = 'TAQzALyftaynnr3VG3rCvzkY2KouFH79sA';
    const marketplaceContractAddress = 'TQaF95pNKxZp8HEVKT7Y4V9WMJYofsEKra';
    const maxUint256 = '0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff';




    
    
    const tokenContractAbi = [
    {
        "inputs": [],
        "stateMutability": "nonpayable",
        "type": "constructor"
    },
    {
        "inputs": [],
        "name": "name",
        "outputs": [
            {
                "internalType": "string",
                "name": "",
                "type": "string"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "symbol",
        "outputs": [
            {
                "internalType": "string",
                "name": "",
                "type": "string"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "decimals",
        "outputs": [
            {
                "internalType": "uint8",
                "name": "",
                "type": "uint8"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "totalSupply",
        "outputs": [
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "owner",
        "outputs": [
            {
                "internalType": "address",
                "name": "",
                "type": "address"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "taxAddress",
        "outputs": [
            {
                "internalType": "address",
                "name": "",
                "type": "address"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "taxRate",
        "outputs": [
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "",
                "type": "address"
            }
        ],
        "name": "whitelist",
        "outputs": [
            {
                "internalType": "bool",
                "name": "",
                "type": "bool"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "",
                "type": "address"
            }
        ],
        "name": "balanceOf",
        "outputs": [
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "",
                "type": "address"
            },
            {
                "internalType": "address",
                "name": "",
                "type": "address"
            }
        ],
        "name": "allowance",
        "outputs": [
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "_to",
                "type": "address"
            },
            {
                "internalType": "uint256",
                "name": "_value",
                "type": "uint256"
            }
        ],
        "name": "transfer",
        "outputs": [
            {
                "internalType": "bool",
                "name": "success",
                "type": "bool"
            }
        ],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "_spender",
                "type": "address"
            },
            {
                "internalType": "uint256",
                "name": "_value",
                "type": "uint256"
            }
        ],
        "name": "approve",
        "outputs": [
            {
                "internalType": "bool",
                "name": "success",
                "type": "bool"
            }
        ],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "_from",
                "type": "address"
            },
            {
                "internalType": "address",
                "name": "_to",
                "type": "address"
            },
            {
                "internalType": "uint256",
                "name": "_value",
                "type": "uint256"
            }
        ],
        "name": "transferFrom",
        "outputs": [
            {
                "internalType": "bool",
                "name": "success",
                "type": "bool"
            }
        ],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "uint256",
                "name": "_taxRate",
                "type": "uint256"
            }
        ],
        "name": "setTaxRate",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "_taxAddress",
                "type": "address"
            }
        ],
        "name": "setTaxAddress",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "_account",
                "type": "address"
            },
            {
                "internalType": "bool",
                "name": "_isWhitelisted",
                "type": "bool"
            }
        ],
        "name": "updateWhitelist",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": true,
                "internalType": "address",
                "name": "from",
                "type": "address"
            },
            {
                "indexed": true,
                "internalType": "address",
                "name": "to",
                "type": "address"
            },
            {
                "indexed": false,
                "internalType": "uint256",
                "name": "value",
                "type": "uint256"
            }
        ],
        "name": "Transfer",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": true,
                "internalType": "address",
                "name": "owner",
                "type": "address"
            },
            {
                "indexed": true,
                "internalType": "address",
                "name": "spender",
                "type": "address"
            },
            {
                "indexed": false,
                "internalType": "uint256",
                "name": "value",
                "type": "uint256"
            }
        ],
        "name": "Approval",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": false,
                "internalType": "uint256",
                "name": "oldRate",
                "type": "uint256"
            },
            {
                "indexed": false,
                "internalType": "uint256",
                "name": "newRate",
                "type": "uint256"
            }
        ],
        "name": "TaxRateChanged",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": false,
                "internalType": "address",
                "name": "oldAddress",
                "type": "address"
            },
            {
                "indexed": false,
                "internalType": "address",
                "name": "newAddress",
                "type": "address"
            }
        ],
        "name": "TaxAddressChanged",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": true,
                "internalType": "address",
                "name": "account",
                "type": "address"
            },
            {
                "indexed": false,
                "internalType": "bool",
                "name": "isWhitelisted",
                "type": "bool"
            }
        ],
        "name": "WhitelistUpdated",
        "type": "event"
    }
];

  
  const marketplaceContractAbi = [ {
  "inputs": [
    {
      "internalType": "address",
      "name": "tokenAddress",
      "type": "address"
    }
  ],
  "stateMutability": "nonpayable",
  "type": "constructor"
},
{
  "inputs": [
    {
      "internalType": "uint256",
      "name": "tokenAmount",
      "type": "uint256"
    },
    {
      "internalType": "uint256",
      "name": "priceInTRX",
      "type": "uint256"
    }
  ],
  "name": "listToken",
  "outputs": [],
  "stateMutability": "nonpayable",
  "type": "function"
},
{
  "inputs": [
    {
      "internalType": "uint256",
      "name": "listingId",
      "type": "uint256"
    }
  ],
  "name": "buyToken",
  "outputs": [],
  "stateMutability": "payable",
  "type": "function"
},
{
  "inputs": [
    {
      "internalType": "uint256",
      "name": "listingId",
      "type": "uint256"
    }
  ],
  "name": "cancelListing",
  "outputs": [],
  "stateMutability": "nonpayable",
  "type": "function"
},
{
  "inputs": [],
  "name": "getActiveListings",
  "outputs": [
    {
      "internalType": "uint256[]",
      "name": "",
      "type": "uint256[]"
    },
    {
      "components": [
        {
          "internalType": "address",
          "name": "seller",
          "type": "address"
        },
        {
          "internalType": "uint128",
          "name": "tokenAmount",
          "type": "uint128"
        },
        {
          "internalType": "uint128",
          "name": "priceInTRX",
          "type": "uint128"
        },
        {
          "internalType": "bool",
          "name": "isActive",
          "type": "bool"
        }
      ],
      "internalType": "struct TokenMarketplace.Listing[]",
      "name": "",
      "type": "tuple[]"
    }
  ],
  "stateMutability": "view",
  "type": "function"
}
];

   // TronLink connection
document.addEventListener('DOMContentLoaded', async () => {
    document.getElementById('connect-button').addEventListener('click', connectWallet);

    if (await checkTronLinkInstalled()) {
        await initializeTronWeb();
        setInterval(updateUI, 60000); // Update UI every minute
    } else {
        console.error('TronLink is not installed.');
    }
});

// Check if TronLink is installed
async function checkTronLinkInstalled() {
    return new Promise((resolve) => {
        const interval = setInterval(() => {
            if (window.tronWeb && window.tronWeb.defaultAddress.base58) {
                clearInterval(interval);
                resolve(true);
            }
        }, 1000);
    });
}

// Connect the wallet using TronLink
async function connectWallet() {
    try {
        await tronLink.request({ method: 'tron_requestAccounts' });
        await initializeTronWeb();
    } catch (e) {
        console.error('Failed to connect to TronLink:', e);
    }
}

// Initialize TronWeb and the contracts
async function initializeTronWeb() {
    try {
        tronWeb = window.tronWeb;
        userAddress = tronWeb.defaultAddress.base58;

        if (!userAddress) throw new Error('User address not available');

        // Initialize contracts using ABI and contract addresses
        tokenContract = await tronWeb.contract(tokenContractAbi, tokenContractAddress);
        marketplaceContract = await tronWeb.contract(marketplaceContractAbi, marketplaceContractAddress);

        console.log('Connected to TronLink.');
        console.log('User Address:', userAddress);
        console.log('Contracts initialized successfully');

        // Hide connect wallet button once connected
        document.getElementById('connect-button').style.display = 'none';

        // Update the UI after initializing contracts
        await updateUI();

        // Setup event listeners
        setupEventListeners();
    } catch (error) {
        console.error('Error initializing TronWeb or Contracts:', error);
    }
}

// UI update function
async function updateUI() {
    try {
        const balance = await tronWeb.trx.getBalance(userAddress);
        console.log('Balance:', tronWeb.fromSun(balance), 'TRX');
        await fetchMarketplaceListings();  // Ensure this function exists
    } catch (error) {
        console.error('Error updating UI:', error);
    }
}

// Setup event listeners for buttons
function setupEventListeners() {
    document.getElementById('approveAndListButton').addEventListener('click', async () => {
        const tokenAmount = document.getElementById('tokenAmount').value;
        const pricePerTokenInTRX = document.getElementById('pricePerTokenInTRX').value;

        if (tokenAmount && pricePerTokenInTRX) {
            try {
                await approveAndListTokens(tokenAmount, pricePerTokenInTRX);
                setTimeout(refreshUI, 3000);
            } catch (error) {
                console.error('Error listing tokens:', error);
            }
        }
    });
}

// Function to refresh the UI
async function refreshUI() {
    const balance = await tronWeb.trx.getBalance(userAddress);
    console.log('Balance refreshed:', tronWeb.fromSun(balance), 'TRX');
    await fetchMarketplaceListings();
}

// Fetch marketplace listings
async function fetchMarketplaceListings() {
    try {
        const result = await marketplaceContract.methods.getActiveListings().call();
        const listingIds = result[0];
        const listings = result[1];

        const listingsContainer = document.getElementById('listings');
        listingsContainer.innerHTML = '';

        for (let i = 0; i < listingIds.length; i++) {
            const listingId = listingIds[i];
            const listing = listings[i];

            if (listing.isActive) {
                const tokenAmount = tronWeb.fromSun(listing.tokenAmount);
                const totalPrice = tronWeb.fromSun(listing.priceInTRX);
                const isSeller = listing.seller.trim().toLowerCase() === userAddress.trim().toLowerCase();

                const listingElement = document.createElement('div');
                listingElement.className = 'listing';
                listingElement.innerHTML = `
                    <p>Seller: ${listing.seller}</p>
                    <p>Token Amount: ${tokenAmount}</p>
                    <p>Total Price: ${totalPrice} TRX</p>
                    <button class="btn btn-success mb-2" onclick="buyToken(${listingId}, ${totalPrice})">Buy</button>
                    ${isSeller ? `<button class="btn btn-danger" onclick="cancelListing(${listingId})">Cancel</button>` : ''}
                `;
                listingsContainer.appendChild(listingElement);
            }
        }
    } catch (error) {
        console.error(error);
        alert('Failed to fetch listings.');
    }
}

// Buy token from the marketplace
async function buyToken(listingId, totalPrice) {
    try {
        await marketplaceContract.methods.buyToken(listingId).send({
            callValue: tronWeb.toSun(totalPrice)
        });

        alert('Token purchased successfully!');
        fetchMarketplaceListings();
    } catch (error) {
        console.error('Error buying token:', error);
        alert('Failed to buy tokens.');
    }
}

// Cancel a listing from the marketplace
async function cancelListing(listingId) {
    try {
        await marketplaceContract.methods.cancelListing(listingId).send();
        alert('Listing cancelled successfully!');
        fetchMarketplaceListings();
    } catch (error) {
        console.error('Error cancelling listing:', error);
        alert('Failed to cancel listing.');
    }
}

// Approve and list tokens for sale
async function approveAndListTokens(tokenAmount, priceInTRX) {
    const adjustedTokenAmount = tronWeb.toSun(tokenAmount);
    const adjustedPriceInTRX = tronWeb.toSun(priceInTRX);

    try {
        await tokenContract.methods.approve(marketplaceContractAddress, adjustedTokenAmount).send();
        await marketplaceContract.methods.listToken(adjustedTokenAmount, adjustedPriceInTRX).send();
        alert('Tokens listed successfully!');
        fetchMarketplaceListings();
    } catch (error) {
        console.error(error);
        alert('Failed to list tokens.');
    }
}

// Utility function to format numbers
function formatNumber(num) {
    return parseFloat(num).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

// Utility function to format whole numbers
function formatWholeNumber(num) {
    return Math.floor(parseFloat(num)).toLocaleString('en-US');
}

  </script>
</body>
</html>
