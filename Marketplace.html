<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRC20 Token Marketplace</title>
</head>
<body>
    <a href="index.html">Go to claim Page</a>
    <h1>TRC20 Token Marketplace</h1>
    <div>
        <h2>List Tokens for Sale</h2>
        <form id="listTokenForm">
            <label for="amount">Amount:</label>
            <input type="number" id="amount" required>
            <label for="price">Price (in TRX):</label>
            <input type="number" id="price" required>
            <button type="submit">List Tokens</button>
        </form>
    </div>
    <div>
        <h2>Available Listings</h2>
        <ul id="listings"></ul>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/@tronweb3/tronweb"></script>
    <script>
        const CONTRACT_ADDRESS = 'TPh2ehqh24ZmS5kkQmZeNMif6Pb1QedTsT';
        const TOKEN_ADDRESS = 'TWRJ4z9BnERjx9gKzBT9GkiCbPYmWCc4jb';
        const TOKEN_DECIMALS = 6; // Adjust this to your token's decimals

        let tronWeb;
        let contract;

        async function connectToTronLink() {
            if (window.tronLink && window.tronLink.ready) {
                await window.tronLink.request({ method: 'tron_requestAccounts' });
                tronWeb = window.tronWeb;
                return true;
            } else if (window.tronWeb && window.tronWeb.defaultAddress.base58) {
                tronWeb = window.tronWeb;
                return true;
            } else {
                console.error('TronLink wallet not found or not ready.');
                alert('TronLink wallet not found. Please install TronLink.');
                return false;
            }
        }

        async function initContract() {
            try {
                contract = await tronWeb.contract().at(CONTRACT_ADDRESS);
            } catch (error) {
                console.error('Failed to initialize contract:', error);
                alert('Failed to initialize contract. Please try again.');
            }
        }

        async function listToken(event) {
            event.preventDefault();
            const amount = document.getElementById('amount').value;
            const price = document.getElementById('price').value;

            const adjustedAmount = amount * (10 ** TOKEN_DECIMALS); // Adjust for token decimals
            const userAddress = tronWeb.defaultAddress.base58;
            const tokenContract = await tronWeb.contract().at(TOKEN_ADDRESS);

            try {
                // Approve the marketplace contract to transfer tokens on behalf of the user
                await tokenContract.approve(CONTRACT_ADDRESS, adjustedAmount).send({ from: userAddress });

                // List tokens for sale
                await contract.listToken(adjustedAmount, price).send({ from: userAddress });

                alert('Tokens listed for sale!');
                loadListings();
            } catch (error) {
                console.error('Failed to list tokens:', error);
                alert('Failed to list tokens. Please try again.');
            }
        }

        async function buyToken(seller, amount) {
            try {
                const listing = await contract.listings(seller, amount).call();
                const price = listing.price;

                const userAddress = tronWeb.defaultAddress.base58;
                await contract.buyToken(seller, amount).send({ from: userAddress, callValue: price });

                alert('Tokens bought successfully!');
                loadListings();
            } catch (error) {
                console.error('Failed to buy tokens:', error);
                alert('Failed to buy tokens. Please try again.');
            }
        }

        async function loadListings() {
            const listings = document.getElementById('listings');
            listings.innerHTML = '';

            try {
                const allListings = await contract.getAllListings().call();

                allListings.forEach(listing => {
                    const adjustedAmount = listing.amount / (10 ** TOKEN_DECIMALS); // Adjust for token decimals
                    const li = document.createElement('li');
                    li.innerHTML = `Seller: ${listing.seller}, Amount: ${adjustedAmount}, Price: ${listing.price} TRX 
                    <button onclick="buyToken('${listing.seller}', '${listing.amount}')">Buy</button>`;
                    listings.appendChild(li);
                });
            } catch (error) {
                console.error('Error fetching listings:', error);
                alert('Error fetching listings. Please try again.');
            }
        }

        document.getElementById('listTokenForm').addEventListener('submit', listToken);

        window.addEventListener('load', async () => {
            const connected = await connectToTronLink();
            if (connected) {
                await initContract();
                loadListings();
                setInterval(loadListings, 300000); // Refresh listings every 5 minutes (300000 ms)
            }
        });
    </script>
</body>
</html>
