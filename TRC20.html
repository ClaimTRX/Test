<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRC20 Token Claimer</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            text-align: center; 
            padding: 20px; 
            background-color: #f2f2f2;
        }
        h1 {
            margin-bottom: 0;
        }
        p {
            font-size: 16px;
            margin: 20px auto;
            max-width: 600px;
            line-height: 1.6;
        }
        a {
            color: #007BFF;
            text-decoration: none;
        }
        a:hover, a:focus {
            text-decoration: underline;
        }
        button, input { 
            margin: 10px; 
            padding: 20px 30px;
            cursor: pointer; 
            border-radius: 8px;
            border: none;
        }
        button:not(.disabled) { 
            background-color: #4CAF50; 
            color: white;
        }
        .disabled { 
            background-color: #ccc; 
            color: #666;
            cursor: not-allowed;
        }
        #tokens { 
            display: none;
        }
        #whitelistMessage {
            margin-top: 20px;
            color: red;
            font-size: 20px;
        }
        .hidden { 
            display: none; 
        }
        @media (max-width: 768px) {
            p {
                font-size: 14px;
                padding: 0 10px;
            }
            button, input {
                padding: 15px 20px;
            }
        }
    </style>
</head>
<body>
    <h1>TRC20 Token Claimer</h1>

    <div id="whitelistMessage">
        <p>Contact <a href="https://t.me/Stian_86">Stian_86 on Telegram</a> to be whitelisted for this page.</p>
    </div>

    <button id="connectWallet">Connect TronLink Wallet</button>

    <div id="tokens" class="hidden">
        <div>
            <p id="token1Name">Token 1:</p>
            <p id="claimableAmount1">Claimable Amount: 0</p>
            <button id="claimToken1">Claim Token 1</button>
        </div>
        <div>
            <p id="token2Name">Token 2:</p>
            <p id="claimableAmount2">Claimable Amount: 0</p>
            <button id="claimToken2">Claim Token 2</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/tronweb/dist/TronWeb.js"></script>
    <script>
        let tronWeb;
        const contractAddress = "TDz3ou9AzJZL4W8if5rMP5pqkqeDqbfGJX";
        const claimerABI = [
            {
                "constant": true,
                "inputs": [{"name": "_tokenAddr", "type": "address"}],
                "name": "viewAccumulatedAmount",
                "outputs": [{"name": "", "type": "uint256"}],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": false,
                "inputs": [{"name": "_tokenAddr", "type": "address"}],
                "name": "claimTokens",
                "outputs": [],
                "payable": false,
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [{"name": "_tokenAddr", "type": "address"}],
                "name": "isCooldownActive",
                "outputs": [{"name": "", "type": "bool"}],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [{"name": "_address", "type": "address"}],
                "name": "whitelist",
                "outputs": [{"name": "", "type": "bool"}],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            }
        ];

        const trc20ABI = [
            {
                "constant": true,
                "inputs": [],
                "name": "name",
                "outputs": [{"name": "", "type": "string"}],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            }
        ];

        const tokenAddresses = {
            'TSknFHj7ej6qP86dJFYkGVxVeH5x1CM6D1': 'claimToken1',
            'TWRJ4z9BnERjx9gKzBT9GkiCbPYmWCc4jb': 'claimToken2'
        };

        document.getElementById('connectWallet').addEventListener('click', async function() {
            try {
                await tronLink.request({ method: 'tron_requestAccounts' });
                if (window.tronWeb && window.tronWeb.defaultAddress.base58) {
                    tronWeb = window.tronWeb;
                    await isWhitelisted();
                } else {
                    alert('Please install TronLink or log in.');
                }
            } catch (error) {
                console.error('Error connecting to TronLink:', error);
            }
        });

        async function checkWhitelistStatus() {
            if (!tronWeb || !tronWeb.defaultAddress.base58) {
                console.error('TronLink is not connected.');
                return;
            }

            const walletAddress = tronWeb.defaultAddress.base58;
            console.log('Connected wallet address:', walletAddress);
            const contract = await tronWeb.contract(claimerABI, contractAddress);

            try {
                const isWhitelisted = await contract.whitelist(walletAddress).call();
                if (isWhitelisted) {
                    document.getElementById('whitelistMessage').classList.add('hidden');
                    document.getElementById('tokens').classList.remove('hidden');
                    document.getElementById('connectWallet').innerText = 'Connected';
                    fetchTokenNames();
                    updateClaimableAmounts();
                    checkCooldowns();
                    setInterval(updateClaimableAmounts, 10000); // Updates every 10 seconds
                } else {
                    document.getElementById('whitelistMessage').classList.remove('hidden');
                    document.getElementById('tokens').classList.add('hidden');
                }
            } catch (error) {
                console.error('Error checking whitelist status:', error);
            }
        }

        async function fetchTokenNames() {
            for (const [address, buttonId] of Object.entries(tokenAddresses)) {
                try {
                    const tokenContract = await tronWeb.contract(trc20ABI, address);
                    const tokenName = await tokenContract.name().call();
                    document.getElementById(`token${Object.keys(tokenAddresses).indexOf(address) + 1}Name`).innerText = `Token: ${tokenName}`;
                    document.getElementById(buttonId).innerText = `Claim ${tokenName}`;
                } catch (error) {
                    console.error(`Error fetching name for token ${address}:`, error);
                }
            }
        }

        async function updateClaimableAmounts() {
            const contract = await tronWeb.contract(claimerABI, contractAddress);
            for (const [address, amountElementId] of Object.entries(tokenAddresses)) {
                try {
                    const amount = await contract.viewAccumulatedAmount(address).call();
                    const formattedAmount = tronWeb.toBigNumber(amount).div(1e6).toFixed(0);
                    document.getElementById(`claimableAmount${Object.keys(tokenAddresses).indexOf(address) + 1}`).innerText = 'Claimable Amount: ' + formattedAmount;
                } catch (error) {
                    console.error(`Error fetching amount for token ${address}:`, error);
                }
            }
        }

        async function checkCooldowns() {
            const contract = await tronWeb.contract(claimerABI, contractAddress);
            for (const [address, buttonId] of Object.entries(tokenAddresses)) {
                try {
                    const isCooldownActive = await contract.isCooldownActive(address).call();
                    const button = document.getElementById(buttonId);
                    if (isCooldownActive) {
                        button.classList.add("disabled");
                        button.setAttribute("disabled", true);
                    } else {
                        button.classList.remove("disabled");
                        button.removeAttribute("disabled");
                    }
                } catch (error) {
                    console.error(`Error checking cooldown for token ${address}:`, error);
                }
            }
        }

        async function claimToken(tokenAddress) {
            try {
                const contract = await tronWeb.contract(claimerABI, contractAddress);
                const isCooldownActive = await contract.isCooldownActive(tokenAddress).call();

                if (isCooldownActive) {
                    alert('This token is still on cooldown. Please wait before claiming again.');
                    return;
                }

                console.log('Claiming tokens for address:', tokenAddress);
                const result = await contract.claimTokens(tokenAddress).send({
                    from: tronWeb.defaultAddress.base58
                });

                console.log('Claim transaction result:', result);
                alert('Claim successful! Transaction ID: ' + result);
                checkCooldowns();
            } catch (error) {
                console.error('Claim failed:', error);
                alert('Claim failed: ' + error.message);
            }
        }

        document.getElementById('claimToken1').addEventListener('click', function() {
            claimToken('TSknFHj7ej6qP86dJFYkGVxVeH5x1CM6D1');
        });

        document.getElementById('claimToken2').addEventListener('click', function() {
            claimToken('TWRJ4z9BnERjx9gKzBT9GkiCbPYmWCc4jb');
        });
    </script>
</body>
</html>
