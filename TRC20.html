<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRC20 Token Claimer</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            text-align: center; 
            padding: 20px; 
            background-color: #f2f2f2;
        }
        h1 {
            margin-bottom: 0;
        }
        p {
            font-size: 16px;
            margin: 20px auto;
            max-width: 600px;
            line-height: 1.6;
        }
        a {
            color: #007BFF;
            text-decoration: none;
        }
        a:hover, a:focus {
            text-decoration: underline;
        }
        button, input { 
            margin: 10px; 
            padding: 20px 30px;
            cursor: pointer; 
            border-radius: 8px;
            border: none;
        }
        button:not(.disabled) { 
            background-color: #4CAF50; 
            color: white;
        }
        .disabled { 
            background-color: #ccc; 
            color: #666;
            cursor: not-allowed;
        }
        #tokens { 
            display: none;
        }
        #logoContainer {
            text-align: center;
            margin: 0 auto;
            padding: 20px;
        }

        #logo {
            max-width: 100%;
            height: auto;
            width: auto;
        }

        @media (max-width: 768px) {
            #logoContainer {
                padding: 10px;
            }

            #logo {
                max-width: 80%;
            }
        }
    
        #whitelistMessage {
            display: none;
            color: red;
            font-size: 18px;
            margin-top: 20px;
        }
        #cooldownTimer {
            color: red;
            font-size: 18px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <a href="index.html">Go to claim Page</a>
    <h1>TRC20 Token Claimer</h1>

    <p>Claim TRC20 tokens once every 72 hours. Energy is consumed from users addresses, so make sure the claimable amount is worth claiming. Tokens accumulate every minute. Will you claim now or risk someone else claiming before you? If you need Energy, you can <a href="https://tronnrg.com/r/TXgL1i4dF1vEhDYuVsMuo8ovcfdEE6tztA" target="_blank">rent it from TronNRG</a>.</p>

    <button id="connectWallet">Connect TronLink Wallet</button>

    <p id="whitelistMessage">Contact <a href="https://t.me/Stian_86">Stian_86 on Telegram</a> to be whitelisted for this page.</p>
    <h2>Need energy? visit TronNRG</h2>
    <div id="logoContainer">
        <a href="https://tronnrg.com/r/TXgL1i4dF1vEhDYuVsMuo8ovcfdEE6tztA/" target="_blank" rel="noopener noreferrer">
            <img id="logo" src="https://github.com/ClaimTRX/Test/blob/main/affiliateProgramEnglish.png?raw=true" alt="Affiliate Program Logo">
        </a>
    </div>
    <div id="tokens">
        <div>
            <p id="token1Name">Token 1:</p>
            <p id="claimableAmount1">Claimable Amount: 0</p>
            <button id="claimToken1" onclick="claimToken(0)">Claim</button>
        </div>
        <div>
            <p id="token2Name">Token 2:</p>
            <p id="claimableAmount2">Claimable Amount: 0</p>
            <button id="claimToken2" onclick="claimToken(1)">Claim</button>
        </div>
        <div>
            <p id="token3Name">Token 3:</p>
            <p id="claimableAmount3">Claimable Amount: 0</p>
            <button id="claimToken3" onclick="claimToken(2)">Claim</button>
        </div>
        <div>
            <p id="token4Name">Token 4:</p>
            <p id="claimableAmount4">Claimable Amount: 0</p>
            <button id="claimToken4" onclick="claimToken(3)">Claim</button>
        </div>
        <div>
            <p id="token5Name">Token 5:</p>
            <p id="claimableAmount5">Claimable Amount: 0</p>
            <button id="claimToken5" onclick="claimToken(4)">Claim</button>
        </div>
        <p id="cooldownTimer"></p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/tronweb/dist/TronWeb.js"></script>
    <script>
        const contractAddress = 'TJcj6Urt5TEF7bTMbYBoRCJWPbzmjufZk1';
        let tronWeb;
        let contract;

        async function checkWhitelistStatus() {
            try {
                const walletAddress = tronWeb.defaultAddress.base58;
                if (!walletAddress) throw new Error("Invalid Wallet Address");

                const isWhitelisted = await contract.isWhitelisted(walletAddress).call();
                const appContent = document.getElementById('tokens');
                const warningMessage = document.getElementById('whitelistMessage');

                if (isWhitelisted) {
                    appContent.style.display = 'block';
                    warningMessage.style.display = 'none';
                    updateClaimableAmounts();
                    updateCooldownTimers();
                    setInterval(updateClaimableAmounts, 1000); // Updates every second
                    setInterval(updateCooldownTimers, 1000); // Updates every second
                } else {
                    appContent.style.display = 'none';
                    warningMessage.style.display = 'block';
                }
            } catch (error) {
                console.error("Whitelist Check Error: ", error.message);
                alert("An error occurred while checking whitelist status.");
            }
        }

        async function init() {
            try {
                if (window.tronWeb && window.tronWeb.ready) {
                    tronWeb = window.tronWeb;
                    contract = await tronWeb.contract().at(contractAddress);

                    const connectButton = document.getElementById('connectWallet');
                    connectButton.classList.add('connected');
                    connectButton.textContent = 'Wallet Connected';

                    await checkWhitelistStatus();
                } else {
                    alert("Please install TronLink or open in a supported browser.");
                }
            } catch (error) {
                console.error("Initialization Error: ", error.message);
                alert("An error occurred while initializing the wallet connection.");
            }
        }

        async function updateClaimableAmounts() {
            try {
                for (let i = 0; i < 5; i++) {
                    const amount = await contract.viewAccumulatedAmount(i).call();
                    const formattedAmount = tronWeb.toBigNumber(amount).div(tronWeb.toBigNumber(10).pow(6)).toNumber(); // Adjust decimals as needed
                    document.getElementById(`claimableAmount${i + 1}`).innerText = 'Claimable Amount: ' + formattedAmount;
                }
            } catch (error) {
                console.error("Error fetching claimable amounts: ", error.message);
            }
        }

        async function updateCooldownTimers() {
            try {
                const address = tronWeb.defaultAddress.base58;
                const lastClaimTime = (await contract.lastUserClaimTime(address).call()).toNumber();
                const cooldownPeriod = (await contract.claimCooldown().call()).toNumber();
                const now = Math.floor(Date.now() / 1000);
                const timeLeft = (lastClaimTime + cooldownPeriod) - now;

                const cooldownTimer = document.getElementById('cooldownTimer');
                const claimButtons = document.querySelectorAll('button[id^="claimToken"]');

                if (timeLeft > 0) {
                    const hours = Math.floor(timeLeft / 3600);
                    const minutes = Math.floor((timeLeft % 3600) / 60);
                    const seconds = timeLeft % 60;
                    cooldownTimer.innerText = `Cooldown: ${hours}h ${minutes}m ${seconds}s`;
                    claimButtons.forEach(button => {
                        button.classList.add('disabled');
                        button.disabled = true;
                    });
                } else {
                    cooldownTimer.innerText = '';
                    claimButtons.forEach(button => {
                        button.classList.remove('disabled');
                        button.disabled = false;
                    });
                }
            } catch (error) {
                console.error("Error fetching last claim time: ", error.message);
            }
        }

        async function claimToken(index) {
            try {
                const result = await contract.claimTokens(index).send({
                    from: tronWeb.defaultAddress.base58
                });

                console.log('Claim transaction result:', result);
                alert('Claim successful! Transaction ID: ' + result);
                await updateCooldownTimers();  // Apply cooldown only after a successful claim
                await updateClaimableAmounts();
            } catch (error) {
                console.error('Claim failed:', error);
                alert('Claim failed: ' + error.message);
            }
        }

        window.addEventListener('load', () => {
            document.getElementById('connectWallet').addEventListener('click', init);
        });
    </script>
</body>
</html>
